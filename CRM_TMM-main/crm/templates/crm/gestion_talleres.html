{% extends 'crm/base.html' %}
{% load static humanize %}

{% block content %}
<style>
    /* --- ESTILOS GENERALES (Coherencia con templates anteriores) --- */
    
    /* Botones */
    .primary-btn {
        background-color: #d63384;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: background 0.2s;
    }
    .primary-btn:hover { background-color: #ad1e62; color: white; }

    .secondary-btn {
        background-color: white;
        color: #d63384;
        border: 1px solid #f3d1d9;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: background 0.2s;
    }
    .secondary-btn:hover { background-color: #fff0f6; }

    /* Grid de Tarjetas */
    .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
        margin-top: 20px;
    }

    /* Tarjeta Individual */
    .card {
        background: white;
        border-radius: 12px;
        border: 1px solid #f3e6ea;
        box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        flex-direction: column;
    }
    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }

    .card-img {
        width: 100%;
        height: 180px;
        object-fit: cover;
        border-bottom: 1px solid #eee;
    }

    .card-body {
        padding: 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .card-title {
        margin: 0 0 10px 0;
        color: #a61e4d;
        font-size: 1.25rem;
    }

    .meta {
        color: #868e96;
        font-size: 0.9rem;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* Badges / Etiquetas */
    .badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .badge-price { background-color: #e6fffa; color: #00a185; }
    .badge-cap { background-color: #fff0f6; color: #d63384; }

    .muted-text {
        color: #666;
        font-size: 0.95rem;
        line-height: 1.5;
        flex: 1; /* Empuja los botones al fondo */
        margin-bottom: 15px;
    }

    /* --- ESTILOS DEL FORMULARIO OCULTO --- */
    #create-form-container {
        display: none; /* Oculto por defecto */
        background: linear-gradient(to bottom right, #fff8f8, #fdf2f8);
        border: 1px solid #fde2e8;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #a61e4d;
    }

    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
    }
    
    .form-group input:focus, .form-group textarea:focus {
        border-color: #d63384;
        outline: none;
    }

</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div>
        <h2 style="margin: 0; color: #333;">Gesti√≥n de Talleres</h2>
        <p style="margin: 5px 0 0 0; color: #777;">Administra, edita y crea nuevos eventos.</p>
    </div>
    <button id="toggle-create-btn" class="primary-btn">
        ‚ûï Crear Nuevo Taller
    </button>
</div>

<div id="create-form-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #d63384;">üìù Registrar Nuevo Taller</h3>
        <button type="button" id="close-form-btn" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#999;">&times;</button>
    </div>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" value="crear_taller" />
        
        <div class="form-grid">
            <div class="form-group">{{ form.nombre.label_tag }} {{ form.nombre }}</div>
            <div class="form-group">{{ form.categoria.label_tag }} {{ form.categoria }}</div>
            <div class="form-group">{{ form.fecha_taller.label_tag }} {{ form.fecha_taller }}</div>
            <div class="form-group">{{ form.hora_taller.label_tag }} {{ form.hora_taller }}</div>
            <div class="form-group">{{ form.modalidad.label_tag }} {{ form.modalidad }}</div>
            <div class="form-group">{{ form.precio.label_tag }} {{ form.precio }}</div>
            <div class="form-group">{{ form.cupos_totales.label_tag }} {{ form.cupos_totales }}</div>
            <div class="form-group">{{ form.esta_activo.label_tag }} {{ form.esta_activo }}</div>
            
            <div class="form-group" style="grid-column: 1 / -1;">
                {{ form.descripcion.label_tag }} {{ form.descripcion }}
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
                {{ form.imagen.label_tag }} {{ form.imagen }}
            </div>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="primary-btn" type="submit">üíæ Guardar Taller</button>
            <button type="button" id="cancel-btn" class="secondary-btn">Cancelar</button>
        </div>
    </form>
</div>

<hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;"/>

<div class="card-grid">
    {% for t in talleres %}
    <div class="card">
        <div style="position: relative;">
            {% if t.imagen %}
                <img class="card-img" src="{{ t.imagen.url }}" alt="{{ t.nombre }}">
            {% else %}
                <div class="card-img" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #ccc;">
                    <span>Sin Imagen</span>
                </div>
            {% endif %}
            
            {% if not t.esta_activo %}
                <span style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">Inactivo</span>
            {% endif %}
        </div>

        <div class="card-body">
            <h3 class="card-title">{{ t.nombre }}</h3>
            
            <div class="meta">
                <span>üìÖ {{ t.fecha_taller|date:"d M Y" }}</span>
                {% if t.hora_taller %}<span>üïí {{ t.hora_taller }}</span>{% endif %}
            </div>
            
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
                <span class="badge badge-price">${{ t.precio|intcomma }}</span>
                <span class="badge badge-cap">üë• {{ t.cupos_disponibles }} / {{ t.cupos_totales }}</span>
            </div>
            
            <p class="muted-text">
                {{ t.descripcion|truncatechars:100 }}
            </p>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <a href="{% url 'detalle_taller_admin' t.id %}" class="primary-btn" style="text-align: center; font-size: 0.9rem;">‚öôÔ∏è Gestionar</a>
                <a href="{% url 'detalle_taller' t.id %}" class="secondary-btn" style="text-align: center; font-size: 0.9rem;">üëÅÔ∏è Ver P√∫blico</a>
            </div>
        </div>
    </div>
    {% empty %}
    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; background: #f9f9f9; border-radius: 10px;">
        <h3 style="color: #777;">No hay talleres activos.</h3>
        <p>Presiona el bot√≥n "Crear Nuevo Taller" para comenzar.</p>
    </div>
    {% endfor %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('toggle-create-btn');
        const formContainer = document.getElementById('create-form-container');
        const closeBtn = document.getElementById('close-form-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        function showForm() {
            formContainer.style.display = 'block';
            // Hacer scroll suave hacia el formulario
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            toggleBtn.style.display = 'none'; // Opcional: ocultar bot√≥n crear mientras est√° abierto
        }

        function hideForm() {
            formContainer.style.display = 'none';
            toggleBtn.style.display = 'inline-block'; // Mostrar bot√≥n crear de nuevo
        }

        if(toggleBtn) toggleBtn.addEventListener('click', showForm);
        if(closeBtn) closeBtn.addEventListener('click', hideForm);
        if(cancelBtn) cancelBtn.addEventListener('click', hideForm);
    });
</script>

{% endblock content %}